{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>{{ folder.name }}</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

    <style>
        body {
            background: linear-gradient(to right, #e3f2fd, #fff);
            font-family: 'Segoe UI', sans-serif;
        }

        .container-box {
            max-width: 1100px;
            margin: 40px auto;
            background: #ffffff;
            padding: 35px;
            border-radius: 14px;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.1);
            position: relative;
        }

        h1 {
            text-align: center;
            margin-bottom: 30px;
            font-weight: bold;
            color: #0d6efd;
        }

        .upload-section {
            margin-bottom: 30px;
        }

        .upload-btn {
            background-color: #198754;
            color: white;
            transition: background 0.3s ease;
        }

        .upload-btn:hover {
            background-color: #157347;
        }

        .file-item, .folder-box {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 12px 20px;
            margin-bottom: 14px;
            background-color: #f9f9f9;
            border: 1px solid #ced4da;
            border-radius: 10px;
            transition: all 0.25s ease;
        }

        .file-item:hover, .folder-box:hover {
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.08);
            background-color: #f1f9ff;
        }

        .download-link {
            margin-left: auto;
            font-size: 22px;
            color: #0d6efd;
            text-decoration: none;
        }

        .download-link:hover {
            color: #0a58ca;
        }

        .context-menu {
            display: none;
            position: absolute;
            z-index: 1000;
            width: 220px;
            background-color: #ffffff;
            border: 1px solid #ced4da;
            box-shadow: 2px 2px 10px rgba(0, 0, 0, 0.15);
            border-radius: 8px;
        }

        .context-menu ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .context-menu li {
            padding: 10px 16px;
            cursor: pointer;
            border-bottom: 1px solid #f1f1f1;
        }

        .context-menu li:hover {
            background-color: #f8f9fa;
        }

        .submenu {
            display: none;
            position: absolute;
            left: 100%;
            top: 0;
            width: 250px;
            background-color: #fff;
            border: 1px solid #ccc;
            border-radius: 6px;
            box-shadow: 2px 2px 8px rgba(0, 0, 0, 0.1);
        }

        .submenu.active {
            display: block;
        }

        .file-icon {
            width: 36px;
            height: 36px;
        }

        a.folder-link {
            text-decoration: none;
            color: inherit;
        }

        .text-muted {
            font-size: 1.1rem;
        }
    </style>
</head>
<body>

<div class="container container-box" id="contextTarget">
    <h1>üìÅ {{ folder.name }}</h1>

    <div class="upload-section">
        <form action="{% url 'upload_file' folder.id %}" method="post" enctype="multipart/form-data" class="d-flex gap-3">
            {% csrf_token %}
            <input type="file" name="file" class="form-control">
            <button type="submit" class="btn upload-btn">Upload File</button>
        </form>
    </div>

    <div id="folder" data-folder-id="{{ folder.id }}">
    {% if files or folders_with_files %}
        
        {% if files %}
            <ul id="fileListContainer" class="list-unstyled">
                {% for file in files %}
    <li class="file-item d-flex align-items-center mb-2" data-file-id="{{ file.id }}">
        {% with file.name|lower as fname %}
            {% if ".txt" in fname %}
                <img src="{% static 'icons/text-icon.png' %}" class="file-icon me-2" alt="Text">
            {% elif ".docx" in fname %}
                <img src="{% static 'icons/word-icon.png' %}" class="file-icon me-2" alt="Word">
            {% elif ".xlsx" in fname %}
                <img src="{% static 'icons/excel-icon.png' %}" class="file-icon me-2" alt="Excel">
            {% elif ".pptx" in fname %}
                <img src="{% static 'icons/ppt-icon.png' %}" class="file-icon me-2" alt="PPT">
            {% elif ".pdf" in fname %}
                <img src="{% static 'icons/pdf-icon.png' %}" class="file-icon me-2" alt="PDF">
            {% elif ".json" in fname %}
                <img src="{% static 'icons/json-icon.png' %}" class="file-icon me-2" alt="JSON">
            {% else %}
                <img src="{% static 'icons/file-icon.png' %}" class="file-icon me-2" alt="File">
            {% endif %}
        {% endwith %}

        <a href="{{ file.path.url }}" target="_blank" class="flex-grow-1 text-decoration-none text-dark">
            {{ file.name }}
        </a>

        <a href="{{ file.path.url }}" download class="ms-2 text-decoration-none" title="Download">üì•</a>
        <button onclick="deleteItem('{{ file.id }}', 'file')" class="btn btn-sm btn-outline-danger ms-2" title="Delete">üóëÔ∏è</button>
    </li>
{% endfor %}

            </ul>
        {% endif %}

        {% if folders_with_files %}
            <div id="folderListContainer" class="mt-3">
                {% for item in folders_with_files %}
                    <a href="{% url 'folder_detail' item.folder.id %}" class="folder-link d-block mb-2" target="_blank">
                        <div class="folder-box d-flex align-items-center">
                            <img src="{% static 'icons/file-icon.png' %}" class="file-icon me-2" alt="Folder">
                            <h5 class="m-0">{{ item.folder.name }}</h5>
                        </div>
                    </a>
                {% endfor %}
            </div>
        {% endif %}

    {% else %}
        <p class="text-muted text-center">No files or folders found.</p>
    {% endif %}
</div>


</div>

<!-- Context Menu -->
<div id="contextMenu" class="context-menu">
    <ul>
        <li onclick="cutFolder()">‚úÇÔ∏è Cut</li>
        <li onclick="copyFolder()">üìã Copy</li>
        <li onclick="pasteFolder()">üìÇ Paste</li>
        <li onclick="deleteFolder()">üóëÔ∏è Delete</li>
        <li onclick="toggleSubmenu(event)">
            ‚ûï New
            <ul id="submenu" class="submenu">
                <li onclick="createItem('folder')">üìÅ Folder</li>
                <li onclick="createItem('text')">üìÑ Text Document</li>
                <li onclick="createItem('word')">üìù Word Document</li>
                <li onclick="createItem('excel')">üìä Excel Sheet</li>
                <li onclick="createItem('ppt')">üìà PowerPoint</li>
                <li onclick="createItem('json')">üßæ JSON File</li>
                <li onclick="createItem('pdf')">üìë PDF File</li>
            </ul>
        </li>
        <li onclick="renameFolder()">‚úèÔ∏è Rename</li>
    </ul>
</div>

<script>
    const contextMenu = document.getElementById("contextMenu");
    const submenu = document.getElementById("submenu");
    const containerBox = document.getElementById("contextTarget");
    const folderId = document.getElementById("folder").dataset.folderId;
    const folderListContainer = document.getElementById("folderListContainer");

    // Right-click only inside container
    containerBox.addEventListener("contextmenu", function (e) {
        e.preventDefault();
        submenu.classList.remove('active');
        contextMenu.style.top = `${e.pageY}px`;
        contextMenu.style.left = `${e.pageX}px`;
        contextMenu.style.display = "block";
    });

    // Hide context menu on click anywhere
    document.addEventListener("click", function () {
        contextMenu.style.display = "none";
        submenu.classList.remove('active');
    });

    function toggleSubmenu(event) {
        event.stopPropagation();
        submenu.classList.toggle('active');
    }

    function sendAction(action, extra = {}) {
        return fetch(`/folder/${folderId}/${action}/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}',
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(extra)
        })
        .then(res => res.json())
        .then(data => {
            if (data.message) alert(data.message);
            if (data.error) alert(data.error);
            return data;
        });
    }

    function createItem(type) {
    const prompts = {
        folder: "Enter folder name:",
        text: "Text document name:",
        word: "Word document name:",
        excel: "Excel sheet name:",
        ppt: "PowerPoint name:",
        json: "JSON file name:",
        pdf: "PDF file name:"
    };

    const name = prompt(prompts[type]);
    if (!name) return;

    sendAction('new', { name, type }).then(data => {
        if (data.id && data.name) {
            const extIconMap = {
                text: "{% static 'icons/text-icon.png' %}",
                word: "{% static 'icons/word-icon.png' %}",
                excel: "{% static 'icons/excel-icon.png' %}",
                ppt: "{% static 'icons/ppt-icon.png' %}",
                pdf: "{% static 'icons/pdf-icon.png' %}",
                json: "{% static 'icons/json-icon.png' %}"
            };

            if (type === 'folder') {
                const folderLink = document.createElement('a');
                folderLink.href = `/folder/${data.id}/`;
                folderLink.className = 'folder-link';
                folderLink.target = '_blank';

                const div = document.createElement('div');
                div.className = 'folder-box';
                div.innerHTML = `
                    <img src="{% static 'icons/file-icon.png' %}" class="file-icon" alt="Folder">
                    <h5 class="m-0">${data.name}</h5>`;
                folderLink.appendChild(div);
                folderListContainer.appendChild(folderLink);
            } else {
                const li = document.createElement('li');
                li.className = 'file-item';
                li.innerHTML = `
                    <img src="${extIconMap[type] || '{% static "icons/file-icon.png" %}'}" class="file-icon" alt="File">
                    <a href="${data.url}" target="_blank" class="flex-grow-1 text-decoration-none text-dark">
                        ${data.name}
                    </a>
                    <a href="${data.url}" download class="download-link" title="Download">üì•</a>`;
                document.getElementById("fileListContainer").appendChild(li);
            }
        }
    });
}

    function cutFolder() { sendAction('cut'); }
    function copyFolder() { sendAction('copy'); }
    function pasteFolder() { sendAction('paste'); }

    function deleteFolder() {
        if (confirm('Are you sure?')) {
            sendAction('delete');
        }
    }

    function renameFolder() {
        const name = prompt('Enter new name:');
        if (name) {
            sendAction('rename', { name });
        }
    }

    function deleteItem(itemId, itemType) {
    if (!confirm(`Delete this ${itemType}?`)) return;

    fetch(`/folder/${folderId}/delete_item/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': '{{ csrf_token }}',
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({ id: itemId, type: itemType })
    })
    .then(res => res.json())
    .then(data => {
        if (data.success) {
            alert(data.success);
            location.reload();
        } else if (data.error) {
            alert(data.error);
        }
    });
}


</script>
</body>
</html>
